var ChainUI=(()=>{var x=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var X=(c,t)=>{for(var e in t)x(c,e,{get:t[e],enumerable:!0})},Y=(c,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of J(t))!K.call(c,i)&&i!==e&&x(c,i,{get:()=>t[i],enumerable:!(n=q(t,i))||n.enumerable});return c};var Q=c=>Y(x({},"__esModule",{value:!0}),c);var et={};X(et,{ChainElement:()=>_,ChainPageRouter:()=>P,ChainRuntime:()=>N,EventDelegator:()=>k,NavManager:()=>M,NavigationController:()=>L,OperationStream:()=>C,OperationType:()=>h,createApp:()=>z,createComponent:()=>$,createRouter:()=>D,createState:()=>O,default:()=>tt,generateId:()=>g,getGlobalIdCounter:()=>G,h:()=>v,map:()=>F,mount:()=>U,render:()=>V,resetGlobalIdCounter:()=>W,valueToString:()=>S});var h={CREATE_ELEMENT:"CREATE_ELEMENT",CREATE_TEXT_NODE:"CREATE_TEXT_NODE",SET_TEXT_CONTENT:"SET_TEXT_CONTENT",APPEND_CHILD:"APPEND_CHILD",REMOVE_CHILD:"REMOVE_CHILD",INSERT_BEFORE:"INSERT_BEFORE",SET_ATTRIBUTE:"SET_ATTRIBUTE",REMOVE_ATTRIBUTE:"REMOVE_ATTRIBUTE",SET_STYLE:"SET_STYLE",ADD_CLASS:"ADD_CLASS",REMOVE_CLASS:"REMOVE_CLASS",ADD_EVENT_LISTENER:"ADD_EVENT_LISTENER",MOUNT:"MOUNT",BIND_STATE:"BIND_STATE",BIND_ATTRIBUTE:"BIND_ATTRIBUTE",BIND_LIST:"BIND_LIST",UPDATE_NODE:"UPDATE_NODE",ROUTE_CHANGE:"ROUTE_CHANGE",ROUTE_MATCH:"ROUTE_MATCH",INIT_ROUTER:"INIT_ROUTER"},B=0,G=()=>B,W=()=>{B=0},g=c=>`${c}-${B++}`,S=c=>{if(c==null)return String(c);if(typeof c=="object")try{return JSON.stringify(c)}catch{return String(c)}return String(c)},A=new Map;function O(c){let t=c,e=new Set;return{get value(){return t},set value(n){Object.is(t,n)||(t=n,e.forEach(i=>i(t)))},update(n){this.value=typeof n=="function"?n(this.value):n},subscribe(n){return e.add(n),n(t),()=>e.delete(n)},toString(){return S(t)},map(n){let i=O(n(t));return this.subscribe(s=>i.update(n(s))),i.isMapped=!0,i}}}var C=class c{constructor(){this.operations=[]}add(t){let e=this.operations[this.operations.length-1];if(e&&t.nodeId===e.nodeId){if(t.type===h.SET_ATTRIBUTE&&e.type===h.SET_ATTRIBUTE&&t.name===e.name){e.value=t.value;return}if(t.type===h.SET_STYLE&&e.type===h.SET_STYLE&&t.property===e.property){e.value=t.value;return}}this.operations.push(t)}getOperations(){return this.operations}clear(){this.operations=[]}serialize(){return JSON.stringify(this.operations)}static deserialize(t){let e=new c;return e.operations=JSON.parse(t),e}},_=class c{constructor(t){this.nodeId=g("node"),this.stream=new C,this.children=[],this.eventHandlers=[],t&&(this.tagName=t,this.stream.add({type:h.CREATE_ELEMENT,nodeId:this.nodeId,tagName:t}))}_bind(t,e){if(t&&typeof t.subscribe=="function"){let n=g("state");e(t.value,this.stream),this.stream.add({type:h.BIND_STATE,nodeId:this.nodeId,stateId:n,updateFn:e,state:t})}else e(t,this.stream);return this}_setAttr(t,e){let n=this.nodeId;if(e&&typeof e.subscribe=="function"&&!e.isMapped){let i=S(e.value);this.stream.add({type:h.SET_ATTRIBUTE,nodeId:n,name:t,value:i}),this.stream.add({type:h.BIND_ATTRIBUTE,nodeId:this.nodeId,name:t,state:e,stateId:g("attr_state")});return}if(e==null){this.stream.add({type:h.REMOVE_ATTRIBUTE,nodeId:n,name:t});return}this._bind(e,(i,s)=>{s.add({type:h.SET_ATTRIBUTE,nodeId:n,name:t,value:i})})}_setStyle(t,e){let n=this.nodeId;this._bind(e,(i,s)=>{s.add({type:h.SET_STYLE,nodeId:n,property:t,value:i})})}_setClass(t,e){let n=this.nodeId;if(e===null||e===!1)this.stream.add({type:h.REMOVE_CLASS,nodeId:n,className:t});else{let i=t.split(" ").filter(Boolean);for(let s of i)this.stream.add({type:h.ADD_CLASS,nodeId:n,className:s})}}set(t,e,n){if(typeof t=="object"&&t!==null&&arguments.length===1){let i=t;if(i.attr)for(let[s,r]of Object.entries(i.attr))this._setAttr(s,r);if(i.style)for(let[s,r]of Object.entries(i.style))this._setStyle(s,r);if(i.class){if(typeof i.class=="string")this._setClass(i.class,!0);else if(Array.isArray(i.class))for(let s of i.class)this._setClass(s,!0);else if(typeof i.class=="object")for(let[s,r]of Object.entries(i.class))this._setClass(s,r)}return this}if(typeof t=="string"){if(!n){let i=typeof document<"u"&&t in document.documentElement.style;n=t.startsWith("data-")||t.includes("-")?"attr":i?"style":"attr"}switch(n){case"style":this._setStyle(t,e);break;case"class":this._setClass(t,e);break;case"attr":default:this._setAttr(t,e);break}}return this}on(t,e){let n=g("action");if(this.stream.add({type:h.ADD_EVENT_LISTENER,nodeId:this.nodeId,eventType:t,actionId:n,handler:e}),typeof window<"u"){let i=null;arguments.length>2&&arguments[2]&&typeof arguments[2]=="object"&&arguments[2].eventDelegator?i=arguments[2]:typeof window.__CHAIN_ACTIVE_RUNTIME__<"u"&&(i=window.__CHAIN_ACTIVE_RUNTIME__),i&&(i.eventDelegator.registerHandlers([{actionId:n,handler:e}]),i.eventDelegator.delegate(t))}return this.eventHandlers.push({actionId:n,eventType:t,handler:e}),this}_createTextChild(t){let e=g("text"),n=t&&typeof t.subscribe=="function",i=n?t.value:t,s=S(i);this.stream.add({type:h.CREATE_TEXT_NODE,nodeId:e,content:s}),this.stream.add({type:h.APPEND_CHILD,parentId:this.nodeId,childId:e}),n&&this.stream.add({type:h.BIND_STATE,nodeId:this.nodeId,stateId:g("state"),updateFn:(r,o)=>{o.add({type:h.SET_TEXT_CONTENT,nodeId:e,content:S(r)})},state:t})}child(...t){for(let e of t.flat())e instanceof c?(this.children.push(e),this.stream.operations.push(...e.stream.getOperations()),this.stream.add({type:h.APPEND_CHILD,parentId:this.nodeId,childId:e.nodeId}),this.eventHandlers.push(...e.eventHandlers)):this._createTextChild(e);return this}mount(t){this.stream.add({type:h.MOUNT,nodeId:this.nodeId,selector:t})}when(t,e,n,i={}){let{keepAlive:s=!1}=i;if(s){let r=e(),o=n?n():null;r&&(r.set("display",t.map(a=>a?"block":"none"),"style"),this.child(r)),o&&(o.set("display",t.map(a=>a?"none":"block"),"style"),this.child(o))}else{let r=new c("div").set("data-chain-placeholder","true","attr");this.child(r);let o=function(a){let d=this.nodeMap?.get(r.nodeId);if(!d)return;let p=d.dataset.childNodeId;if(p){let f=this.nodeMap.get(p);f&&(this.cleanupNodeTree(f),d.contains(f)&&d.removeChild(f)),this.nodeMap.delete(p),delete d.dataset.childNodeId}let u=a?e:n;if(u){let f=u();if(f){let l=this;l.executeOperations(f.stream);let E=l.nodeMap.get(f.nodeId);E&&(d.appendChild(E),d.dataset.childNodeId=f.nodeId,l.bindOperations(f.stream),(E instanceof HTMLInputElement||E instanceof HTMLTextAreaElement)&&setTimeout(()=>E.focus(),10))}}};this.stream.add({type:h.BIND_STATE,nodeId:r.nodeId,stateId:g("when"),updateFn:o,state:t})}return this}toHtml(){let t=r=>typeof r!="string"?String(r):r.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'"').replace(/'/g,"&#039;"),e=[],n=new Set,i=r=>{r.eventHandlers?.length>0&&r.eventHandlers.forEach(o=>{n.has(o.actionId)||(e.push(o),n.add(o.actionId))}),r.children&&r.children.forEach(o=>{o instanceof c&&i(o)})};i(this);let s=r=>{if(r instanceof c){if(!r.tagName)return"";let o=`<${r.tagName}`,a=r.stream.getOperations(),d=a.filter(l=>l.type===h.SET_ATTRIBUTE&&l.nodeId===r.nodeId),p=a.filter(l=>l.type===h.SET_STYLE&&l.nodeId===r.nodeId),u=a.filter(l=>l.type===h.ADD_EVENT_LISTENER&&l.nodeId===r.nodeId);for(let l of d)o+=` ${l.name}="${t(String(l.value))}"`;if(p.length>0){let l="";for(let E of p)l+=`${E.property}: ${t(String(E.value))}; `;o+=` style="${t(l.trim())}"`}for(let l of u)o+=` data-chain-action="${l.actionId}" data-chain-event="${l.eventType}"`;if(o+=">",r.children)for(let l of r.children)o+=s(l);let f=a.filter(l=>l.type===h.CREATE_TEXT_NODE&&a.some(E=>E.type===h.APPEND_CHILD&&E.parentId===r.nodeId&&E.childId===l.nodeId));for(let l of f)o+=t(l.content);return o+=`</${r.tagName}>`,o}else return t(String(r))};return{html:s(this),eventHandlers:e}}},N=class{constructor(){this.nodeMap=new Map,this.stateSubscriptions=new Map,this.nodeSubscriptions=new Map,this.eventDelegator=new k(this),this.batchQueue=[],this.isBatchingScheduled=!1,this.animationFrameId=null}execute(t,e=!1){e?t.forEach(n=>this.applyOperation(n)):(this.batchQueue.push(...t),this.scheduleBatchExecution())}executeOperations(t,e=!1){t&&typeof t.getOperations=="function"&&this.execute(t.getOperations(),e)}bindOperations(t){t&&typeof t.getOperations=="function"&&t.getOperations().filter(e=>e.type===h.BIND_STATE||e.type===h.BIND_LIST).forEach(e=>this.applyOperation(e))}scheduleBatchExecution(){this.isBatchingScheduled||(this.isBatchingScheduled=!0,this.animationFrameId=requestAnimationFrame(()=>{let t=this.batchQueue;this.batchQueue=[],t.forEach(e=>this.applyOperation(e)),this.isBatchingScheduled=!1,this.animationFrameId=null}))}applyOperation(t){let e=this.nodeMap.get(t.nodeId);switch(t.type){case h.CREATE_ELEMENT:{let n=document.createElement(t.tagName);n.dataset.chainId=t.nodeId,this.nodeMap.set(t.nodeId,n);break}case h.CREATE_TEXT_NODE:{this.nodeMap.set(t.nodeId,document.createTextNode(t.content));break}case h.SET_TEXT_CONTENT:{e&&(e.textContent=t.content);break}case h.APPEND_CHILD:{let n=this.nodeMap.get(t.parentId),i=this.nodeMap.get(t.childId);n&&i&&n.appendChild(i);break}case h.SET_ATTRIBUTE:{e&&(t.name==="value"&&"value"in e?e.value=t.value:t.name==="disabled"&&"disabled"in e?e.disabled=!!t.value:e.setAttribute(t.name,t.value));break}case h.SET_STYLE:{e instanceof HTMLElement&&(e.style[t.property]=t.value);break}case h.ADD_CLASS:{e instanceof HTMLElement&&e.classList.add(t.className);break}case h.REMOVE_CLASS:{e instanceof HTMLElement&&e.classList.remove(t.className);break}case h.ADD_EVENT_LISTENER:{e instanceof HTMLElement&&(e.dataset.chainAction=t.actionId,this.eventDelegator.delegate(t.eventType));break}case h.BIND_STATE:{if(t.state&&typeof t.state.subscribe=="function"){let n=this,i=t.state.subscribe(s=>{if(t.updateFn.length===2){let r=new C;t.updateFn.call(n,s,r),n.execute(r.getOperations())}else t.updateFn.call(n,s)});this.stateSubscriptions.set(t.stateId,i),this.nodeSubscriptions.has(t.nodeId)||this.nodeSubscriptions.set(t.nodeId,[]),this.nodeSubscriptions.get(t.nodeId).push(i)}break}case h.BIND_ATTRIBUTE:{if(e instanceof HTMLElement&&t.state&&typeof t.state.subscribe=="function"){let n=t.state.subscribe(i=>{t.name==="disabled"&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLButtonElement)?e.disabled=!!i:e.setAttribute(t.name,S(i))});this.stateSubscriptions.set(t.stateId,n),this.nodeSubscriptions.has(t.nodeId)||this.nodeSubscriptions.set(t.nodeId,[]),this.nodeSubscriptions.get(t.nodeId).push(n)}break}case h.BIND_LIST:{if(t.state&&typeof t.state.subscribe=="function"){let n=t.state.subscribe(i=>{this.reconcileList(t.nodeId,i,t.factory)});this.stateSubscriptions.set(g("sub"),n),this.nodeSubscriptions.has(t.nodeId)||this.nodeSubscriptions.set(t.nodeId,[]),this.nodeSubscriptions.get(t.nodeId).push(n)}break}case h.MOUNT:{let n=document.querySelector(t.selector),i=this.nodeMap.get(t.nodeId);n&&i&&(n.innerHTML="",n.appendChild(i));break}case h.INSERT_BEFORE:{let n=this.nodeMap.get(t.parentId),i=this.nodeMap.get(t.childId),s=this.nodeMap.get(t.anchorId);n&&i&&s&&n.insertBefore(i,s);break}case h.REMOVE_CHILD:{let n=this.nodeMap.get(t.parentId),i=this.nodeMap.get(t.childId);n&&i&&(this.cleanupNodeTree(i),n.removeChild(i));break}case h.INIT_ROUTER:{if(e instanceof HTMLElement&&t.router){if(typeof t.router.init=="function")t.router.init(e);else if(t.router.routes){let n={routes:t.router.routes.map(s=>({path:s.path,component:()=>v("div").set("data-route",s.path),options:s.options||{}})),mode:t.router.mode||"history"},{router:i}=D(n);i&&typeof i.init=="function"&&i.init(e)}}break}}}cleanupNodeTree(t){if(!t)return;this.eventDelegator.clearHandlersForNode(t),(typeof t.querySelectorAll=="function"?[t,...t.querySelectorAll("[data-chain-id]")]:[t]).forEach(n=>{let i=n.dataset?.chainId;i&&(this.nodeSubscriptions.has(i)&&(this.nodeSubscriptions.get(i).forEach(s=>s()),this.nodeSubscriptions.delete(i)),this.nodeMap.delete(i))})}reconcileList(t,e,n){let i=this.nodeMap.get(t);if(!i)return;let s=new Map;for(let o of i.childNodes)o.dataset?.key&&s.set(o.dataset.key,o);let r=[];for(let o=0;o<e.length;o++){let a=e[o],d=String(a.id??o),p=s.get(d);if(p)s.delete(d);else{let u=n(a,o).set("data-key",d,"attr"),f=this;f.executeOperations(u.stream,!0),p=f.nodeMap.get(u.nodeId),f.eventDelegator.registerHandlers(u.eventHandlers),f.bindOperations(u.stream)}r.push(p)}for(let o of s.values())this.cleanupNodeTree(o),i.removeChild(o);for(let o=0;o<r.length;o++){let a=r[o];i.childNodes[o]!==a&&i.insertBefore(a,i.childNodes[o]||null)}}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.batchQueue=[],this.isBatchingScheduled=!1,Array.from(this.nodeMap.values()).forEach(e=>{this.cleanupNodeTree(e)}),this.stateSubscriptions.forEach(e=>{typeof e=="function"&&e()}),this.stateSubscriptions.clear(),this.nodeSubscriptions.forEach(e=>e.forEach(n=>n())),this.nodeSubscriptions.clear(),this.nodeMap.clear(),this.eventDelegator&&typeof this.eventDelegator.destroy=="function"&&this.eventDelegator.destroy(),this.eventDelegator=null,this.batchQueue=null,this.stateSubscriptions=null,this.nodeMap=null}};typeof window<"u"&&(window.__CHAIN_EVENT_HANDLERS__=window.__CHAIN_EVENT_HANDLERS__||{});var k=class{constructor(t){this.runtime=t,this.delegatedEvents=new Set,this.handlerMap=new Map,this.boundHandleEvent=this.handleEvent.bind(this)}registerHandlers(t){t.forEach(({actionId:e,handler:n})=>{this.handlerMap.set(e,n)})}clearHandlersForNode(t){if(!t||typeof t.querySelectorAll!="function")return;[t,...t.querySelectorAll("[data-chain-action]")].forEach(n=>{if(n.dataset?.chainAction){let i=n.dataset.chainAction;i&&this.handlerMap.delete(i)}})}delegate(t){this.delegatedEvents.has(t)||(document.body.addEventListener(t,this.boundHandleEvent,!0),this.delegatedEvents.add(t))}handleEvent(t){let e=t.target;for(;e&&e!==document.body;){let n=e.dataset.chainAction;if(n){if(this.handlerMap.has(n)){this.handlerMap.get(n)(t);return}else if(typeof window<"u"&&window.__CHAIN_EVENT_HANDLERS__?.[n]){window.__CHAIN_EVENT_HANDLERS__[n](t);return}}e=e.parentElement}}destroy(){this.delegatedEvents.forEach(t=>{document.body.removeEventListener(t,this.boundHandleEvent,!0)}),this.delegatedEvents.clear(),this.handlerMap.clear()}};function v(c){return new _(c)}function U(c,t=null){let e=typeof c=="string"?document.querySelector(c):c;if(!e)return console.error(`Mount target not found: ${c}`),null;let n=e.dataset.chainRuntimeId;if(n&&A.has(n)){let r=A.get(n);r&&typeof r.destroy=="function"&&(r.destroy(),A.delete(n))}let i=new N,s=g("runtime");if(e.dataset.chainRuntimeId=s,A.set(s,i),typeof window<"u"&&(window.__CHAIN_ACTIVE_RUNTIME__=i),t instanceof _){let r=t;i.rootNodeId=r.nodeId,i.eventDelegator.registerHandlers(r.eventHandlers),i.executeOperations(r.stream,!0);let o=i.nodeMap.get(r.nodeId);e&&o&&(e.innerHTML="",e.appendChild(o)),i.bindOperations(r.stream)}else if(t?.eventHandlers){if(e){let r=e.querySelectorAll("[data-chain-id]");for(let o of r){let a=o.dataset.chainId;a&&i.nodeMap.set(a,o)}if(e.hasAttribute("data-chain-id")){let o=e.dataset.chainId;o&&i.nodeMap.set(o,e)}}Array.isArray(t.eventHandlers)&&t.eventHandlers.forEach(({actionId:r,eventType:o,handlerCode:a})=>{if(r&&o){if(typeof window<"u"){let d;if(a&&typeof a=="string")try{d=new Function("event",a.substring(a.indexOf("{")+1,a.lastIndexOf("}")))}catch(p){console.warn(`Failed to create handler for action: ${r}`,p),d=u=>{console.log(`Event triggered for action: ${r}`,u)}}else d=p=>{console.log(`Event triggered for action: ${r}`,p)};i.eventDelegator.registerHandlers([{actionId:r,handler:d}])}i.eventDelegator.delegate(o)}})}return{runtime:i,destroy:()=>{i.destroy(),e.dataset.chainRuntimeId===s&&delete e.dataset.chainRuntimeId,A.delete(s)}}}function V(c,t={}){let e=c(),n={},i=a=>{a.stream&&a.stream.getOperations().forEach(d=>{d.type===h.BIND_STATE&&d.state&&(n[d.stateId]=d.state.value)}),a.children&&a.children.forEach(d=>{d instanceof _&&i(d)})};i(e);let{html:s,eventHandlers:r}=e.toHtml(),o=r.map(({actionId:a,eventType:d,handler:p})=>({actionId:a,eventType:d,handlerCode:p&&typeof p=="function"?p.toString().replace(/\s+/g," ").trim():null}));return t.format==="stream"?{stream:e.stream.serialize(),state:n,eventHandlers:o}:{html:s,state:n,clientEventHandlers:o}}function F(c,t){let e=new _("div");return e.stream.add({type:h.BIND_LIST,nodeId:e.nodeId,state:c,factory:t}),e}function $(c,t){return(...e)=>{let n=t(...e);return n.set("data-component",c,"attr"),n}}var L=class{constructor(){this.listeners=new Set}listen(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(t){this.listeners.forEach(e=>e(t))}navigate(t,e,n){throw new Error("Not implemented")}getLocation(){throw new Error("Not implemented")}goBack(){throw new Error("Not implemented")}},M=class extends L{constructor(t={}){super(),this.defaultPath=t.defaultPath||"/",this.mode=t.mode||"history",this.stack=[],this.index=0;let e=this.defaultPath;typeof window<"u"&&window.location?this.mode==="hash"?e=window.location.hash.substring(1)||this.defaultPath:e=window.location.pathname:t.initialPath&&(e=t.initialPath),this.stack=[{path:e,state:{}}]}navigate(t,e={},n=!1){let i={path:t,state:e};if(n&&this.index<this.stack.length?this.stack[this.index]=i:(this.stack=this.stack.slice(0,this.index+1),this.stack.push(i),this.index=this.stack.length-1),typeof window<"u"&&window.history)if(this.mode==="hash"){let s=t.startsWith("/")?t:"/"+t;n?window.history.replaceState(e,"","#"+s):window.history.pushState(e,"","#"+s)}else{let s=new URL(t,window.location.origin);n?window.history.replaceState(e,"",s.toString()):window.history.pushState(e,"",s.toString())}this.notify(i)}getLocation(){return this.stack.length===0?{path:"/",state:{}}:this.stack[this.index]}goBack(){this.index>0&&(this.index--,this.notify(this.stack[this.index]))}toJSON(){return JSON.stringify({stack:this.stack,index:this.index,defaultPath:this.defaultPath})}fromJSON(t){let{stack:e,index:n,defaultPath:i}=JSON.parse(t);this.stack=e,this.index=n,this.defaultPath=i}serialize(){return{stack:this.stack,index:this.index,defaultPath:this.defaultPath}}deserialize(t){this.stack=t.stack||[],this.index=t.index||0,this.defaultPath=t.defaultPath||"/"}},P=class{constructor(t={}){this.pages=new Map,this.currentPage=O({id:null,params:{}}),this._runtimeCache=new Map,this._cacheKeys=[],this.keepAliveCacheLimit=t.keepAliveCacheLimit||10,this.fallbackPath=t.fallbackPath||"/",this.fallbackFactory=null;let{routes:e=[]}=t;if(e&&e.forEach(n=>{n.path&&n.component&&this.register(n.path,n.component,n.options)}),t.history)this.history=t.history;else{let{mode:n,persist:i,initialPath:s}=t;this.history=new M({mode:n,persist:i,initialPath:s})}this.normalizePath=t.normalizePath||(n=>n),this._initEventDelegation(),typeof window>"u"&&this._handleLocationChange(this.history.getLocation())}init(t){this.root=t,this.root.dataset.chainRouter="root";let e={id:null,factory:null};this._cleanupFunctions=new Set;let n=this.currentPage.subscribe(({id:s,params:r})=>{if(this.history.mode==="memory"){e={id:s,factory:this.pages.get(s)?.factory||null};return}if(e.id&&e.factory){let o=this.pages.get(e.id),a=this._runtimeCache.get(e.factory);if(a?.runtime){let d=a.runtime.nodeMap.get(a.runtime.rootNodeId);o&&!o.options.keepAlive?(d&&d.parentNode===this.root&&this.root.removeChild(d),a.runtime&&typeof a.runtime.destroy=="function"&&a.runtime.destroy(),this._runtimeCache.delete(e.factory)):d&&(d.hidden=!0)}}if(!s){this._renderBlank(),e={id:null,factory:null};return}if(this.pages.has(s)){let{factory:o,options:a={}}=this.pages.get(s),d=this._runtimeCache.get(o),p=d?JSON.stringify(d.params)!==JSON.stringify(r):!0;if(d&&a.keepAlive&&p){let u=d.runtime.nodeMap.get(d.runtime.rootNodeId);u&&u.parentNode===this.root&&this.root.removeChild(u),d.runtime&&typeof d.runtime.destroy=="function"&&d.runtime.destroy(),this._runtimeCache.delete(o),d=null}if(d){let u=d.runtime.nodeMap.get(d.runtime.rootNodeId);u&&(u.hidden=!1)}else{let u=o(r),f=new N;f.rootNodeId=u.nodeId,f.eventDelegator.registerHandlers(u.eventHandlers),f.executeOperations(u.stream,!0);let l=f.nodeMap.get(u.nodeId);if(this.root&&l&&this.root.appendChild(l),f.bindOperations(u.stream),this._runtimeCache.set(o,{runtime:f,params:r}),a.keepAlive){let E=this._cacheKeys.indexOf(o);if(E>-1&&this._cacheKeys.splice(E,1),this._cacheKeys.push(o),this._cacheKeys.length>this.keepAliveCacheLimit){let R=this._cacheKeys.shift(),b=this._runtimeCache.get(R);b&&(b.runtime&&typeof b.runtime.destroy=="function"&&b.runtime.destroy(),this._runtimeCache.delete(R))}}}e={id:s,factory:o}}else console.error(`Page not registered: ${s}`),this._renderFallback(),e={id:null,factory:null}});this._cleanupFunctions.add(n);let i=this.history.listen(s=>this._handleLocationChange(s));if(this._cleanupFunctions.add(i),typeof window<"u"&&window.location){let s=window.location.pathname+window.location.search+window.location.hash;this.history?.mode==="hash"&&(s=window.location.hash.substring(1)||"/");let r={path:s,state:{}};this._handleLocationChange(r)}else this._handleLocationChange(this.history.getLocation())}register(t,e,n={}){if(this.pages.has(t))return console.warn(`Route already registered: ${t}`),this;let i=[],s=t.replace(/:(\w+)/g,(r,o)=>(i.push(o),"([^/]+)"));return this.pages.set(t,{factory:e,options:{keepAlive:!1,...n},regex:new RegExp(`^${s}$`),paramNames:i}),this}async navigate(t,e={},n=!1){let{route:i,resolvedParams:s,path:r}=this._matchRoute(t);if(!i)throw new Error(`Unknown route: ${t}`);let o={...s,...e},a=this.currentPage.value;return!a||a.id!==r||this._areParamsChanged(a.params,o)?(a?.id&&this.pages.get(a.id).options.onLeave?.(a.params,{id:r,params:o}),i.options.beforeEnter&&!await Promise.resolve(i.options.beforeEnter(o,a))?this:(this.currentPage.value={id:r,params:o},this.history.navigate(t,o,n),this)):this}goBack(){this.history.goBack()}setFallbackPage(t){this.fallbackFactory=t}getCurrentPage(){return this.currentPage.value}destroy(){this._cleanupFunctions&&(this._cleanupFunctions.forEach(t=>{typeof t=="function"&&t()}),this._cleanupFunctions.clear()),this._runtimeCache&&(this._runtimeCache.forEach(t=>{t.runtime&&typeof t.runtime.destroy=="function"&&t.runtime.destroy()}),this._runtimeCache.clear()),this.history&&typeof this.history.destroy=="function"&&this.history.destroy(),this.pages&&this.pages.clear(),this._cacheKeys&&(this._cacheKeys.length=0),this._rootPageViewRuntime&&typeof this._rootPageViewRuntime.destroy=="function"&&(this._rootPageViewRuntime.destroy(),this._rootPageViewRuntime=null),this.root=null}_initEventDelegation(){typeof document>"u"||(document.addEventListener("chain:backpress",()=>this.goBack()),typeof window<"u"&&window.addEventListener&&window.addEventListener("popstate",t=>{let e={path:window.location.pathname+window.location.search+window.location.hash,state:t.state||{}};this._handleLocationChange(e)}))}_matchRoute(t){let[e,n]=t.split("?"),i={};if(n){let s=new URLSearchParams(n);for(let[r,o]of s)i[r]=o}for(let[s,r]of this.pages.entries()){let o=e.match(r.regex);if(o){let a={...i};return r.paramNames.forEach((d,p)=>{a[d]=o[p+1]}),{route:r,resolvedParams:a,path:s}}}return{route:null,resolvedParams:null,path:null}}_areParamsChanged(t,e){if(t==null||e===null||e===void 0||typeof t!="object"||typeof e!="object")return t!==e;if(Array.isArray(t)||Array.isArray(e)){if(!Array.isArray(t)||!Array.isArray(e)||t.length!==e.length)return!0;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!0;return!1}let n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!0;for(let s of n)if(!e.hasOwnProperty(s)||t[s]!==e[s])return!0;return!1}_handleLocationChange(t){if(!t?.path)return;let e=t.path;if(this.history?.mode==="hash")e=this.normalizePath(e);else{let a=new URL(t.path,"http://localhost");e=this.normalizePath(a.pathname)}let{route:n,resolvedParams:i,path:s}=this._matchRoute(e);if(!n){e!==this.fallbackPath&&this.navigate(this.fallbackPath,{},!0);return}let r={...i,...t.state||{}},o=this.currentPage.value;(!o||o.id!==s||this._areParamsChanged(o.params,r))&&(this.currentPage.value={id:s,params:r})}_renderBlank(){this.root?.firstChild&&(this.root.innerHTML="")}_renderFallback(){if(this._renderBlank(),this.fallbackFactory){let t=this.fallbackFactory(),e=new N;e.rootNodeId=t.nodeId,e.eventDelegator.registerHandlers(t.eventHandlers),e.executeOperations(t.stream,!0);let n=e.nodeMap.get(t.nodeId);this.root&&n&&this.root.appendChild(n),e.bindOperations(t.stream)}else this.root.innerHTML="<div>404 - Page not found</div>"}};function D(c={}){let{routes:t=[],history:e,normalizePath:n,mode:i,persist:s,initialPath:r}=c,o=m=>{if(Array.isArray(m)){let[y,w,T={}]=m;return{path:y,component:w,options:T}}return m},d=n||(m=>{let y=m;return y===""||y==="/"||y==="/index.html"?"/":(y.startsWith("/")||(y="/"+y),y)}),p=t.map(o),u=new P({history:e,normalizePath:d,mode:i,persist:s,initialPath:r,routes:p}),f=v("div").set("data-chain-router-view",!0);f.stream.add({type:h.INIT_ROUTER,nodeId:f.nodeId,router:u});let l=new N;l.rootNodeId=f.nodeId,l.executeOperations(f.stream,!0);let E={runtime:l,destroy:()=>l.destroy()};l.bindOperations(f.stream),u._rootPageViewRuntime=E;function R(m,y,...w){let T=m;if(y)for(let[I,H]of Object.entries(y))T.includes(`:${I}`)&&(T=T.replace(`:${I}`,encodeURIComponent(H)));return v("a").set("href",T).on("click",I=>{I.preventDefault(),u.navigate(T,y)}).child(...w)}return{router:u,Link:({to:m,params:y,...w},...T)=>{let I=R(m,y,...T);for(let[H,j]of Object.entries(w))I.set(H,j);return I},PageView:f,rootPageViewRuntime:E}}function z(c={}){let{mount:t,routes:e=[],...n}=c;if(!t)throw new Error("createApp requires a 'mount' selector in its configuration.");let{mode:i,persist:s,initialPath:r,...o}=n,{router:a,Link:d,PageView:p,rootPageViewRuntime:u}=D({routes:e,mode:i,persist:s,initialPath:r,...o}),f=typeof t=="string"?document.querySelector(t):t;if(f&&u.runtime.nodeMap.has(p.nodeId)){let l=u.runtime.nodeMap.get(p.nodeId);f.innerHTML="",f.appendChild(l)}return{router:a,Link:d,destroy:()=>{a.destroy(),u&&typeof u.destroy=="function"&&u.destroy()}}}var Z={h:v,createState:O,createComponent:$,createApp:z,createRouter:D,map:F,mount:U,render:V},tt=Z;return Q(et);})();
